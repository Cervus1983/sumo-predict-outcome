---
title: "Predictive model for sumo wrestling"
output: html_notebook
---

```{r message=FALSE, warning=FALSE}
library(mlr)
library(tidyverse)
```

```{r message=FALSE}
banzuke <- read_csv("csv/banzuke.csv")
results <- read_csv("csv/results.csv")
odds <- read_csv("csv/odds.csv")
```

&nbsp;

# Raw data

First of all, we get access to high-quality raw data:

* banzuke,
* results,
* odds (scraped from Marathon bet).

```{r}
filter(banzuke, basho == 2018.01)
```

```{r}
filter(results, basho == 2018.01)
```

```{r}
filter(odds, basho == 2018.01)
```

&nbsp;

# Input data

We generate useful features to feed into our model:

```{r}
all_data <- readRDS("data.rds")

data <- all_data %>% 
	select(
		-basho,
		-rikishi1_id,
		-rikishi1_rank,
		-rikishi1_shikona,
		-rikishi1_result,
		-rikishi1_win,
		-kimarite,
		-rikishi2_id,
		-rikishi2_rank,
		-rikishi2_shikona,
		-rikishi2_result,
		-rikishi2_win,
		-rikishi1_birth_date,
		-rikishi1_prev,
		-rikishi2_birth_date,
		-rikishi2_prev,
		-rikishi1_form,
		-rikishi2_form,
		-odds1_open,
		-odds2_open,
		-odds1_close,
		-odds2_close
	) %>% 
	mutate_if(is.ordered, as.integer)

data %>% 
	select(-is_train, -y) %>% 
	tail(5) %>% 
	t() %>% 
	prmatrix(collab = rep("", 5))
```

&nbsp;

Not all variables prove equally important:

```{r warning=FALSE, fig.width=10}
learner <- makeLearner("classif.binomial", predict.type = "prob")

task <- makeClassifTask(
	"Sumo",
	data = select(data, -is_train),
	target = "y",
	positive = "yes"
)

task %>% 
	generateFilterValuesData(method = "information.gain") %>% 
	plotFilterValues(n.show = ncol(data) - 2)
```

&nbsp;

# Model performance

Confusion matrix:

```{r}
model <- train(learner, task)

pred <- predict(model, task, subset = !data$is_train)

calculateConfusionMatrix(pred)
```

&nbsp;

[ROC curve](http://www.statisticshowto.com/receiver-operating-characteristic-roc-curve/) of the <span style="color: #00c1de">**model**</span> is noticeably above those of Marathonbet's <span style="color: #00953a">**opening**</span> and <span style="color: #ed1c24">**closing**</span> odds:

```{r fig.width=10}
library(ROCR)

mb_open <- with(
	all_data %>% filter(!is_train) %>% transmute(p = 1 / odds1_open / (1 / odds1_open + 1 / odds2_open), y),
	prediction(predictions = p, labels = y)
)

mb_close <- with(
	all_data %>% filter(!is_train) %>% transmute(p = 1 / odds1_close / (1 / odds1_close + 1 / odds2_close), y),
	prediction(predictions = p, labels = y)
)

my_model <- prediction(
	predictions = pred[["data"]][["prob.yes"]],
	labels = pred[["data"]][["truth"]]
)

plot(ROCR::performance(mb_open, "tpr", "fpr"), col = "#00953a", lwd = 2)
plot(ROCR::performance(mb_close, "tpr", "fpr"), add = TRUE, col = "#ed1c24", lwd = 2)
plot(ROCR::performance(my_model, "tpr", "fpr"), add = TRUE, col = "#00c1de", lwd = 2)

lines(x = c(0, 1), y = c(0, 1), lty = 2)
```

&nbsp;

Predictions for 2018 January basho. The last three columns refer to the probability of the first rikishi to win:

```{r}
all_data %>% 
	filter(!is_train) %>% 
	transmute(
		basho, day,
		rank1 = rikishi1_rank, shikona1 = rikishi1_shikona,
		shikona2 = rikishi2_shikona, rank2 = rikishi2_rank,
		mb_open = 1 / odds1_open / (1 / odds1_open + 1 / odds2_open),
		mb_close = 1 / odds1_close / (1 / odds1_close + 1 / odds2_close),
		model = pred[["data"]][["prob.yes"]]
	) %>% 
	filter(basho == 2018.01) %>% 
	select(-basho)
```

&nbsp;
